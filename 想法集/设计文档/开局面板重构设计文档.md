# MClite 开局面板重构设计文档

## 一、需求理解与分析

### 1.1 现有问题

当前 [`GameStartPanel.vue`](src/MClite/components/game/GameStartPanel.vue) 采用的是**硬编码固定区块**的方式：

- **场景设定**：场景类型/名称/描述（固定字段）
- **世界观**：纯文本框
- **玩家设定**：姓名/年龄/职位/部门（固定字段）
- **规章制度**：
  - 花名册字段（标签式）
  - 主规章制度（条目式，仅标题级别）
  - 着装规定（条目式，仅标题级别）
  - 申请表模板（条目式，仅名称级别）
  - 其他规则（条目式）
- **补充说明**：纯文本框

**核心缺陷**：

1. 文档类型固定死了"主规章制度"、"着装规定"、"申请表"三种，无法自由创建新文档
2. 文档内容只能输入一级条目的标题，无法构建多层级的递归结构
3. 申请表定义只能写名称，无法定义具体的 `$formMeta` 和 `$fieldDef`
4. 所有文档都依赖 AI 生成，玩家无法精确控制文档的具体内容和层级结构
5. 生成的提示词只是"指引"，AI 可能不按预期生成

### 1.2 需求核心

> **让玩家像编辑大纲/思维导图一样，自由创建和编辑任意数量、任意层级的文档，前端自动将编辑结果转换为 `MC.文档` 变量结构。**

具体来说：

- **自由创建文档**：不限于三种固定类型，想创建什么文档就创建什么文档
- **层级编辑**：支持 章 > 节 > 条 > 款 > 项 > 目 的递归嵌套结构
- **申请表定义**：可以把文档标记为"表单文档"，并在节点上定义表单字段
- **变量自动生成**：玩家只需填写内容，前端自动生成符合 `_t` + `_s` 递归结构 + `$meta` 可拓展标签的完整变量
- **AI参与可选**：可选择是否让 AI 参与文档润色

---

## 二、架构设计

### 2.1 核心理念：文档蓝图编辑器（Document Blueprint Editor）

将开局面板从"填表单→生成提示词→AI生成"模式，改为"可视化编辑→前端直接生成变量→(可选)AI润色"模式。

```
┌─────────────────────────────────────────────────────────────────────┐
│                        开局面板 (重构后)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─ 基础设定区 ──────────────────────────────────────────────────┐ │
│  │  场景类型/名称/描述 + 世界观 + 玩家信息 (基本不变)              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─ 花名册Schema定义器 ────────────────────────────────────────┐   │
│  │  字段定义 (标签式 + 英文ID自动生成)                           │   │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─ 文档蓝图编辑器 (核心) ──────────────────────────────────────┐ │
│  │                                                                │ │
│  │  ┌ 文档列表 ─────────┐  ┌ 文档内容编辑 ──────────────────┐  │ │
│  │  │                    │  │                                  │  │ │
│  │  │  📜 员工守则       │  │  大纲/树形编辑器                 │  │ │
│  │  │  📝 物资申请办法 ✦ │  │  (可拖拽排序、增删节点)          │  │ │
│  │  │  📝 个人需求办法 ✦ │  │                                  │  │ │
│  │  │  📄 培训手册       │  │  第一章 总则                     │  │ │
│  │  │                    │  │    ├ 第一节 机构概述              │  │ │
│  │  │  [+ 新建文档]      │  │    │  ├ 第一条 [正文...]         │  │ │
│  │  │                    │  │    │  ├ 第二条 [正文...]         │  │ │
│  │  │  ✦ = 含表单定义    │  │    │  └ 第三条                   │  │ │
│  │  │                    │  │    │       ├ _t: [正文...]       │  │ │
│  │  └────────────────────┘  │    │       └ _s:                │  │ │
│  │                           │    │           ├ 一: [正文]     │  │ │
│  │                           │    │           ├ 二: [正文]     │  │ │
│  │                           │    │           └ 三: [正文]     │  │ │
│  │                           │    └ 第二节 ...                  │  │ │
│  │                           │  第二章 ...                      │  │ │
│  │                           └──────────────────────────────────┘  │ │
│  │                                                                │ │
│  │  [AI参与模式] 🔘 前端直生成(精确模式) / 🔘 AI润色(智能模式)   │ │
│  │                                                                │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─ 底部操作栏 ──────────────────────────────────────────────────┐ │
│  │  [📁 预设] [🎲 随机] [🔄 重置] [👁️ 预览变量] [🚀 开始游戏]   │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 两种AI参与模式

#### 模式A：前端直生成（精确模式）

```
玩家编辑文档蓝图 → 前端自动转换为完整 MC.文档 变量
                   → 前端生成 MC.花名册.$schema
                   → 提示词只包含: 基础设定 + "请基于已初始化的变量生成开局场景"
                   → AI 仅负责: 正文叙事 + 创建初始NPC + 设置系统变量
```

- **优点**：文档内容完全由玩家控制，AI 不会"改写"玩家的规章制度
- **缺点**：需要玩家自己写完整的条款内容（不过可以只写大纲让AI后续补充）

#### 模式B：AI润色（智能模式）

```
玩家编辑文档蓝图 → 前端先将蓝图转换为变量结构（草稿）
                   → 提示词包含: 基础设定 + 文档草稿 + "请基于以下文档蓝图润色和完善"
                   → AI 负责: 正文叙事 + 补全文档 + 创建NPC + 设置变量
                   → AI 输出 UpdateVariable 覆盖文档变量
```

- **优点**：玩家可以只写大纲/要点，AI 自动扩展为完整的规章制度
- **缺点**：AI 可能修改/遗漏部分内容

### 2.3 数据流

```
                    ┌──────────────┐
                    │   玩家操作    │
                    └──────┬───────┘
                           │
                    ┌──────▼───────┐
                    │ 蓝图编辑器   │ ← 可视化树形编辑
                    │ (Vue组件)    │
                    └──────┬───────┘
                           │
                    ┌──────▼───────┐
                    │ 蓝图数据模型 │ ← DocumentBlueprint[]
                    │ (前端内存)   │    (简化的编辑态数据)
                    └──────┬───────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
        ┌─────▼─────┐ ┌───▼────┐ ┌─────▼─────┐
        │ 变量生成器 │ │提示词  │ │ 预览渲染器 │
        │(蓝图→变量) │ │生成器  │ │(蓝图→预览) │
        └─────┬─────┘ └───┬────┘ └───────────┘
              │            │
              │  ┌─────────▼─────────┐
              │  │  AI (可选润色)     │
              │  └─────────┬─────────┘
              │            │
        ┌─────▼────────────▼─────┐
        │  MC.文档 / MC.花名册    │ ← 最终变量
        │  (酒馆变量存储)         │
        └────────────────────────┘
```

---

## 三、数据模型设计

### 3.1 文档蓝图（编辑态数据结构）

编辑态使用扁平化+引用的结构，方便UI操作（拖拽、增删、展开折叠等），最终由转换器生成实际的变量结构。

```typescript
/**
 * 文档蓝图 - 编辑态的文档定义
 * 一个蓝图对应一个 MC.文档.xxx 条目
 */
interface DocumentBlueprint {
  /** 文档唯一ID（编辑态用，不影响变量key） */
  id: string;
  /** 文档key（对应 MC.文档 下的key，如"员工守则"） */
  docKey: string;
  /** 文档标题（对应 title 字段） */
  title: string;
  /** 文档描述 */
  description?: string;
  /** 是否为表单文档 */
  isFormDocument: boolean;
  /** 表单元数据（仅 isFormDocument=true 时有效） */
  formMeta?: BlueprintFormMeta;
  /** 根级子节点ID列表（有序） */
  rootNodeIds: string[];
}

/**
 * 蓝图节点 - 编辑态的文档节点
 * 对应递归自相似结构中的一个节点
 */
interface BlueprintNode {
  /** 节点唯一ID（编辑态用） */
  id: string;
  /** 所属文档蓝图ID */
  blueprintId: string;
  /** 父节点ID（null 表示根级节点） */
  parentId: string | null;
  /** 节点key（层级编号，如"第一章 总则"、"第一条"、"一"） */
  nodeKey: string;
  /** 节点层级深度（0=章, 1=节, 2=条, 3=款, 4=项, 5=目） */
  depth: number;
  /** 节点类型 */
  type: 'leaf' | 'branch';
  /** 正文内容（叶子节点就是全部内容，分支节点对应 _t） */
  text: string;
  /** 子节点ID列表（有序，仅分支节点有） */
  childIds: string[];
  /** 表单字段定义（可选，对应 $fieldDef） */
  fieldDefs?: BlueprintFieldDef[];
  /** 是否展开（UI状态） */
  expanded: boolean;
}

/**
 * 蓝图表单元数据
 */
interface BlueprintFormMeta {
  formName: string;
  description?: string;
  /** 申请记录存储路径的类别名（如"物资申请"） */
  targetCategory: string;
  /** 审批流程步骤 */
  workflow: BlueprintWorkflowStep[];
}

/**
 * 蓝图审批流程步骤
 */
interface BlueprintWorkflowStep {
  name: string;
  handler: string;
  canReject?: boolean;
}

/**
 * 蓝图表单字段定义
 * 简化版，玩家只需填写关键信息
 */
interface BlueprintFieldDef {
  /** 字段标签 */
  label: string;
  /** 输入类型 */
  inputType: 'text' | 'textarea' | 'number' | 'date' | 'datetime' 
    | 'select' | 'radio' | 'checkbox' | 'readonly' | 'table';
  /** 是否必填 */
  required?: boolean;
  /** 占位提示 */
  placeholder?: string;
  /** 选项列表（select/radio用） */
  options?: string[];
  /** 数据源（readonly用，如"MC.玩家.姓名"） */
  source?: string;
  /** 是否从花名册选择 */
  fromRoster?: boolean;
}
```

### 3.2 花名册Schema蓝图

```typescript
/**
 * 花名册Schema蓝图
 * 玩家定义字段，前端自动生成 $schema 和 英文fieldId
 */
interface RosterSchemaBlueprintField {
  /** 中文显示名 */
  label: string;
  /** 英文字段ID（自动生成，玩家可修改） */
  fieldId: string;
  /** 字段类型提示 */
  typeHint: 'string' | 'number' | 'array';
  /** 是否为主键 */
  isPrimaryKey?: boolean;
  /** 是否为显示字段 */
  isDisplayField?: boolean;
  /** 是否为分组字段 */
  isGroupByField?: boolean;
}

interface RosterSchemaBlueprint {
  fields: RosterSchemaBlueprintField[];
}
```

### 3.3 全局开局蓝图

```typescript
/**
 * 开局蓝图 - 整合所有开局配置
 */
interface GameStartBlueprint {
  // === 基础设定 (保持不变) ===
  sceneType: SceneType;
  sceneName: string;
  sceneDescription: string;
  worldView: string;
  
  // === 玩家设定 (保持不变) ===
  playerName: string;
  playerAge: number | null;
  playerPosition: string;
  playerDepartment: string;
  
  // === 花名册Schema ===
  rosterSchema: RosterSchemaBlueprint;
  
  // === 文档蓝图 ===
  documents: DocumentBlueprint[];
  /** 所有节点的扁平Map（nodeId → node） */
  nodeMap: Map<string, BlueprintNode>;
  
  // === AI参与模式 ===
  aiMode: 'precise' | 'polish';
  
  // === 补充说明 ===
  additionalNotes: string;
}
```

---

## 四、组件设计

### 4.1 组件树

```
GameStartPanel.vue (重构后的开局面板)
├── BasicSettingsSection.vue        # 基础设定区（场景+世界观+玩家）
│   ├── SceneTypeSelector.vue       # 场景类型选择器（复用现有）
│   └── PlayerInfoForm.vue          # 玩家信息表单
│
├── RosterSchemaEditor.vue          # 花名册Schema编辑器
│   └── SchemaFieldItem.vue         # 单个Schema字段编辑行
│
├── DocumentBlueprintEditor.vue     # 文档蓝图编辑器（核心）
│   ├── DocumentList.vue            # 左侧文档列表
│   │   └── DocumentListItem.vue    # 文档列表项
│   │
│   ├── DocumentTreeEditor.vue      # 右侧文档树编辑器
│   │   └── TreeNodeEditor.vue      # 递归的树节点编辑组件
│   │       ├── NodeKeyEditor.vue   # 节点编号/标题编辑
│   │       ├── NodeTextEditor.vue  # 节点正文编辑
│   │       └── FieldDefEditor.vue  # 表单字段定义编辑器
│   │
│   ├── FormMetaEditor.vue          # 表单元数据编辑器（$formMeta）
│   └── AIModeSelector.vue          # AI参与模式选择器
│
├── BlueprintPreviewPanel.vue       # 蓝图→变量预览面板
│
└── BottomActionBar.vue             # 底部操作栏（预设/预览/开始）
```

### 4.2 核心组件详细设计

#### 4.2.1 DocumentBlueprintEditor（文档蓝图编辑器）

整体采用**左右分栏**布局：

```
┌─ 文档蓝图编辑器 ────────────────────────────────────────────────────┐
│                                                                      │
│  ┌─ 文档列表(左) ──────┐  ┌─ 编辑器(右) ──────────────────────────┐│
│  │                      │  │                                        ││
│  │  [🔍 搜索文档...]    │  │  ┌ 文档头部 ────────────────────────┐ ││
│  │                      │  │  │ 📜 员工守则              [表单✓] │ ││
│  │  📜 员工守则      ◀──│──│──│ 标题: [________________]         │ ││
│  │  📝 物资申请办法  ✦  │  │  │ 描述: [________________]         │ ││
│  │  📝 需求申请办法  ✦  │  │  └──────────────────────────────────┘ ││
│  │                      │  │                                        ││
│  │  ─────────────────── │  │  ┌ 工具栏 ──────────────────────────┐ ││
│  │  [+ 新建文档]        │  │  │ [+章] [+节] [+条] │ [展开全部]   │ ││
│  │  [+ 从模板创建]      │  │  │ [+叶子] [+分支]   │ [折叠全部]   │ ││
│  │                      │  │  └──────────────────────────────────┘ ││
│  │                      │  │                                        ││
│  │                      │  │  ┌ 节点树 ──────────────────────────┐ ││
│  │                      │  │  │                                    │ ││
│  │                      │  │  │  ▼ 第一章 总则                    │ ││
│  │                      │  │  │    ▼ 第一节 机构概述              │ ││
│  │                      │  │  │      ● 第一条: [正文内容...]      │ ││
│  │                      │  │  │      ● 第二条: [正文内容...]      │ ││
│  │                      │  │  │      ▼ 第三条                     │ ││
│  │                      │  │  │        📝 [本处工作遵循以下...]   │ ││
│  │                      │  │  │        ├ 一: [忠诚原则...]        │ ││
│  │                      │  │  │        ├ 二: [保密原则...]        │ ││
│  │                      │  │  │        └ 三: [服从原则...]        │ ││
│  │                      │  │  │    ▼ 第二节 组织架构              │ ││
│  │                      │  │  │      ...                           │ ││
│  │                      │  │  │  ▼ 第二章 日常行为规范            │ ││
│  │                      │  │  │    ...                              │ ││
│  │                      │  │  │                                    │ ││
│  │                      │  │  └──────────────────────────────────┘ ││
│  │                      │  │                                        ││
│  └──────────────────────┘  └────────────────────────────────────────┘│
│                                                                      │
│  ┌─ AI参与模式 ───────────────────────────────────────────────────┐ │
│  │ 🔘 精确模式：前端直接生成变量，AI不参与文档创建                  │ │
│  │ ○ 智能模式：AI基于蓝图润色和补全文档内容                        │ │
│  │   💡 精确模式下，文档内容完全由你掌控；智能模式下，AI会自动扩展  │ │
│  └────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 TreeNodeEditor（树节点编辑器 - 递归组件）

这是最关键的组件，采用**递归自渲染**：

```
┌─ 树节点 ────────────────────────────────────────────────────────────┐
│                                                                      │
│  ┌─ 节点头部 ──────────────────────────────────────────────────────┐│
│  │ [拖拽柄] [▼/▶] 第一条 [编辑key] │ 🔧[操作菜单] [+子节点] [×]   ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─ 节点内容（展开时显示）─────────────────────────────────────────┐│
│  │                                                                    ││
│  │  【叶子节点模式】                                                  ││
│  │  ┌────────────────────────────────────────────────────────┐      ││
│  │  │ [textarea] 在此输入条款正文内容...                       │      ││
│  │  │                                                          │      ││
│  │  └────────────────────────────────────────────────────────┘      ││
│  │                                                                    ││
│  │  【分支节点模式】                                                  ││
│  │  正文(_t):                                                         ││
│  │  ┌────────────────────────────────────────────────────────┐      ││
│  │  │ [textarea] 该节点的引导性正文...                         │      ││
│  │  └────────────────────────────────────────────────────────┘      ││
│  │                                                                    ││
│  │  [📋 $fieldDef] (可选，点击展开表单字段定义)                      ││
│  │                                                                    ││
│  │  子节点(_s):                                                       ││
│  │  ┌──────────────────────────────────────────────────────┐        ││
│  │  │  ● 一: [文本内容...]                                   │        ││
│  │  │  ● 二: [文本内容...]                                   │        ││
│  │  │  ▼ 三:                                                 │        ││
│  │  │    📝 [正文...]                                        │        ││
│  │  │    ├ 1: [文本...]                                      │        ││
│  │  │    └ 2: [文本...]                                      │        ││
│  │  │  [+ 添加子节点]                                        │        ││
│  │  └──────────────────────────────────────────────────────┘        ││
│  │                                                                    ││
│  └────────────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────────┘
```

**节点操作菜单**：

- 转换为叶子/分支节点
- 添加子节点（自动推断下一级编号）
- 在上方/下方插入同级节点
- 添加 `$fieldDef`（表单文档专用）
- 复制/删除节点
- 上移/下移

#### 4.2.3 RosterSchemaEditor（花名册Schema编辑器）

```
┌─ 花名册字段定义 ────────────────────────────────────────────────────┐
│                                                                      │
│  💡 定义人员档案的字段结构，前端自动生成 $schema                     │
│                                                                      │
│  ┌ 常用字段快速添加 ─────────────────────────────────────────────┐  │
│  │ [+姓名] [+性别] [+年龄] [+部门] [+职位] [+身高] [+体重] ...  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌ 已定义字段 ──────────────────────────────────────────────────┐  │
│  │                                                                │  │
│  │  🔑 id    │ 员工编号 │ string │ 主键 ✓  │ 显示 □  │ 分组 □  │  │
│  │  ── name  │ 姓名     │ string │ 主键 □  │ 显示 ✓  │ 分组 □  │  │
│  │  ── gender│ 性别     │ string │ 主键 □  │ 显示 □  │ 分组 □  │  │
│  │  ── age   │ 年龄     │ number │ 主键 □  │ 显示 □  │ 分组 □  │  │
│  │  ── dept  │ 所属部门 │ string │ 主键 □  │ 显示 □  │ 分组 ✓  │  │
│  │  ── ...   │ ...      │ ...    │ ...     │ ...     │ ...     │  │
│  │                                                                │  │
│  │  [+ 添加自定义字段]                                            │  │
│  │                                                                │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  自动生成的中文字段名 → 英文fieldId映射由前端处理                    │
│  如：姓名→name, 性别→gender, 年龄→age, 所属部门→department         │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

#### 4.2.4 FieldDefEditor（表单字段定义编辑器）

在表单文档的分支节点中，点击"添加表单字段"后出现：

```
┌─ 表单字段定义 ($fieldDef) ──────────────────────────────────────────┐
│                                                                      │
│  ┌ 字段 1 ──────────────────────────────────────────────────────┐  │
│  │  标签: [物资类别______]  类型: [▼ select]  必填: [✓]          │  │
│  │  选项: [办公用品] [电子设备] [工作装备] [+添加]                │  │
│  │                                                        [×删除]│  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌ 字段 2 ──────────────────────────────────────────────────────┐  │
│  │  标签: [申请数量______]  类型: [▼ number]  必填: [✓]          │  │
│  │  最小值: [1]  最大值: [100]                                    │  │
│  │                                                        [×删除]│  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  [+ 添加字段]  [📋 从花名册选择器]                                   │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 4.3 AI参与模式选择器

```
┌─ AI参与模式 ─────────────────────────────────────────────────────────┐
│                                                                       │
│  文档生成方式:                                                        │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │ 🔘 精确模式（推荐自定义玩家）                                    │ │
│  │    前端直接将你编辑的文档蓝图转换为游戏变量。                     │ │
│  │    AI 只负责叙事正文和NPC创建，不会修改你的文档内容。              │ │
│  │    ✅ 完全掌控 ✅ 不依赖AI理解力 ❌ 需要自己写完整内容            │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │ ○ 智能模式（推荐懒人/快速开局）                                  │ │
│  │    AI 会基于你的文档蓝图进行润色、扩展和补全。                    │ │
│  │    你只需要写大纲和要点，AI 会生成完整的规章制度。                 │ │
│  │    ✅ 省事 ✅ 内容丰富 ❌ AI可能修改/遗漏你的意图                 │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 五、蓝图→变量转换逻辑

### 5.1 转换器核心逻辑

```typescript
/**
 * BlueprintToVariableConverter
 * 将编辑态的蓝图数据转换为 MC.文档 变量结构
 */
class BlueprintToVariableConverter {
  
  /**
   * 将单个文档蓝图转换为 DocumentEntry
   */
  convertDocument(blueprint: DocumentBlueprint, nodeMap: Map<string, BlueprintNode>): DocumentEntry {
    const result: DocumentEntry = {
      $meta: { extensible: true },
      title: blueprint.title,
      description: blueprint.description,
    };
    
    // 如果是表单文档，添加 $formMeta
    if (blueprint.isFormDocument && blueprint.formMeta) {
      result.$formMeta = this.convertFormMeta(blueprint.formMeta);
    }
    
    // 递归转换根级节点
    for (const nodeId of blueprint.rootNodeIds) {
      const node = nodeMap.get(nodeId);
      if (node) {
        result[node.nodeKey] = this.convertNode(node, nodeMap);
      }
    }
    
    return result;
  }
  
  /**
   * 递归转换节点
   */
  convertNode(node: BlueprintNode, nodeMap: Map<string, BlueprintNode>): DocNodeValue {
    if (node.type === 'leaf') {
      // 叶子节点 → 纯字符串
      return node.text;
    }
    
    // 分支节点 → { _t, _s, $fieldDef }
    const branch: DocBranchNode = {};
    
    if (node.text) {
      branch._t = node.text;
    }
    
    if (node.childIds.length > 0) {
      branch._s = { $meta: { extensible: true } };
      for (const childId of node.childIds) {
        const child = nodeMap.get(childId);
        if (child) {
          branch._s[child.nodeKey] = this.convertNode(child, nodeMap);
        }
      }
    }
    
    if (node.fieldDefs && node.fieldDefs.length > 0) {
      branch.$fieldDef = node.fieldDefs.length === 1
        ? this.convertFieldDef(node.fieldDefs[0])
        : node.fieldDefs.map(fd => this.convertFieldDef(fd));
    }
    
    return branch;
  }
  
  /**
   * 转换花名册Schema蓝图为 $schema
   */
  convertRosterSchema(schema: RosterSchemaBlueprint): object {
    const fields: Record<string, string> = {};
    let primaryKey = 'id';
    let displayField = 'name';
    let groupByField = 'department';
    
    for (const field of schema.fields) {
      fields[field.fieldId] = field.label;
      if (field.isPrimaryKey) primaryKey = field.fieldId;
      if (field.isDisplayField) displayField = field.fieldId;
      if (field.isGroupByField) groupByField = field.fieldId;
    }
    
    return { primaryKey, displayField, groupByField, fields };
  }
}
```

### 5.2 节点编号自动推断

当用户在某个层级添加新节点时，前端自动推断编号：

```typescript
/**
 * 编号推断规则
 * 基于当前层级深度和父节点的上下文
 */
const NUMBERING_PATTERNS = [
  // depth 0: 章
  { depth: 0, pattern: (n: number) => `第${chineseNumber(n)}章`, placeholder: '章标题' },
  // depth 1: 节
  { depth: 1, pattern: (n: number) => `第${chineseNumber(n)}节`, placeholder: '节标题' },
  // depth 2: 条
  { depth: 2, pattern: (n: number) => `第${chineseNumber(n)}条`, placeholder: '' },
  // depth 3: 款（一二三四...）
  { depth: 3, pattern: (n: number) => chineseNumber(n), placeholder: '' },
  // depth 4: 项（1 2 3 4...）
  { depth: 4, pattern: (n: number) => `${n}`, placeholder: '' },
  // depth 5: 目（a b c d...）
  { depth: 5, pattern: (n: number) => String.fromCharCode(96 + n), placeholder: '' },
];

/**
 * 为章/节级自动附加标题输入
 * 章 → "第X章 [标题]"，需要玩家填写标题部分
 * 条及以下 → 纯编号，无需标题
 */
```

### 5.3 中文→英文字段ID自动映射

```typescript
/**
 * 常用中文字段名 → 英文字段ID映射表
 */
const CHINESE_TO_ENGLISH_FIELD: Record<string, string> = {
  '姓名': 'name',
  '性别': 'gender',
  '年龄': 'age',
  '部门': 'department',
  '所属部门': 'department',
  '职位': 'position',
  '职务': 'position',
  '职级': 'rank',
  '身高': 'height',
  '体重': 'weight',
  '三围': 'measurements',
  '面容评分': 'faceScore',
  '性格特征': 'personality',
  '综合评级': 'rating',
  '备注': 'notes',
  '入职年限': 'yearsOfService',
  '特长': 'specialSkill',
  '成绩排名': 'gradeRank',
  '学历': 'education',
  '员工编号': 'id',
  '学号': 'id',
  '工号': 'id',
  '军号': 'id',
  '班级': 'class',
  '科室': 'department',
  '军衔': 'rank',
  '体能评级': 'fitnessRating',
  '专业技能': 'professionalSkill',
};

/**
 * 对于映射表中没有的字段，使用 pinyin 或 camelCase 转换
 * 如 "胸部评级" → "bustRating"（需要一个简单的拼音转换或hash函数）
 */
```

---

## 六、文档模板系统

### 6.1 预置文档模板

当用户创建新文档时，可以选择从模板创建：

```typescript
const DOCUMENT_TEMPLATES = {
  /** 通用规章制度模板 */
  generalRules: {
    name: '通用规章制度',
    description: '包含总则、行为规范、奖惩等基本框架',
    structure: [
      { key: '第一章 总则', children: [
        { key: '第一节 适用范围', children: [
          { key: '第一条', text: '' },  // 留空让用户填写
          { key: '第二条', text: '' },
        ]},
        { key: '第二节 基本原则', children: [
          { key: '第三条', text: '', children: [
            { key: '一', text: '' },
            { key: '二', text: '' },
          ]},
        ]},
      ]},
      { key: '第二章 行为规范', children: [
        { key: '第一节 考勤管理', children: [] },
        { key: '第二节 着装规范', children: [] },
      ]},
      { key: '第三章 奖惩制度', children: [] },
    ],
  },
  
  /** 申请表模板 */
  applicationForm: {
    name: '申请表管理办法',
    description: '包含 $formMeta 和基本字段定义框架',
    isFormDocument: true,
    formMeta: {
      formName: '',      // 用户填写
      description: '',   // 用户填写
      targetCategory: '', // 用户填写
      workflow: [
        { name: '填写申请', handler: '申请人' },
        { name: '上级审批', handler: '直属上级', canReject: true },
        { name: '部门审核', handler: '管理部门', canReject: true },
      ],
    },
    structure: [
      { key: '第一章 总则', children: [
        { key: '第一条', text: '' },
      ]},
      { key: '第二章 申请表单', children: [
        { key: '第一节 申请人信息', children: [
          { key: '第二条', text: '系统将自动读取申请人信息。', fieldDefs: [
            { label: '申请人姓名', inputType: 'readonly', source: 'MC.玩家.姓名' },
            { label: '所属部门', inputType: 'readonly', source: 'MC.玩家.部门' },
          ]},
        ]},
        { key: '第二节 申请详情', children: [] },
      ]},
    ],
  },
  
  /** 空白文档 */
  blank: {
    name: '空白文档',
    description: '从零开始创建文档',
    structure: [],
  },
};
```

### 6.2 场景预设扩展

现有的场景类型预设（办公室/学校/医院/军队）扩展为预置一整套文档蓝图：

```typescript
const SCENE_PRESET_DOCUMENTS: Record<SceneType, DocumentBlueprint[]> = {
  office: [
    // 预生成员工守则蓝图（带部分默认内容）
    // 预生成物资申请管理办法蓝图（含 $formMeta 和 $fieldDef）
    // 预生成个人需求申请管理办法蓝图
  ],
  school: [
    // 学生守则蓝图
    // 请假申请管理办法蓝图
  ],
  hospital: [
    // 工作制度蓝图
    // 物资申请蓝图
  ],
  military: [
    // 纪律条令蓝图
    // 物资申请蓝图
  ],
  custom: [],
};
```

---

## 七、提示词生成策略

### 7.1 精确模式提示词

精确模式下，文档变量由前端直接生成，AI只需处理正文和其他内容：

```markdown
请根据以下设定开始游戏：

## 场景设定
- 场景类型：{sceneType}
- 场景名称：{sceneName}
...

## 玩家信息
...

## 已初始化的变量说明
以下变量已由系统预先初始化，你无需再创建它们：
- MC.文档：已包含 {documentCount} 个文档（{documentNames}）
- MC.花名册.$schema：已定义字段结构

## 你的任务
1. 生成开局场景描述
2. 使用 <UpdateVariable> 初始化以下变量：
   - MC.系统（当前时间、当前地点）
   - MC.玩家
   - MC.世界设定
   - MC.花名册.entries（创建2-3个初始NPC，参照已定义的 $schema.fields）
   - MC.申请记录（初始化为空容器）
3. **不要修改 MC.文档，它已经由系统完成初始化**
```

### 7.2 智能模式提示词

智能模式下，文档蓝图作为参考提供给AI：

```markdown
请根据以下设定开始游戏，并完善文档内容：

## 场景设定
...

## 文档蓝图
以下是玩家编写的文档大纲，请在此基础上**润色和补全**，保持玩家定义的层级结构，
扩展和丰富每个条款的具体内容，使其成为完整的规章制度文档。

### 文档1: 员工守则
```json
{蓝图JSON}
```

### 文档2: 物资申请管理办法（表单文档）

```json
{蓝图JSON}
```

## 你的任务

1. 生成开局场景描述
2. 使用 <UpdateVariable> 初始化所有变量
3. **重点**：补全和润色 MC.文档 中的内容，采用递归自相似节点结构
4. 创建初始NPC到 MC.花名册

```

---

## 八、实现文件清单

### 8.1 新增文件

| 文件路径 | 说明 |
|----------|------|
| `types/blueprint.ts` | 蓝图相关类型定义 |
| `services/BlueprintService.ts` | 蓝图操作服务（增删改查节点） |
| `services/BlueprintConverter.ts` | 蓝图→变量转换器 |
| `services/BlueprintTemplateService.ts` | 文档模板服务 |
| `stores/blueprintStore.ts` | 蓝图状态管理（Pinia） |
| `composables/useBlueprint.ts` | 蓝图操作组合式API |
| `components/blueprint/DocumentBlueprintEditor.vue` | 文档蓝图编辑器主组件 |
| `components/blueprint/DocumentList.vue` | 文档列表 |
| `components/blueprint/DocumentListItem.vue` | 文档列表项 |
| `components/blueprint/DocumentTreeEditor.vue` | 文档树编辑器 |
| `components/blueprint/TreeNodeEditor.vue` | 递归树节点编辑器 |
| `components/blueprint/NodeKeyEditor.vue` | 节点编号编辑器 |
| `components/blueprint/NodeTextEditor.vue` | 节点正文编辑器 |
| `components/blueprint/FieldDefEditor.vue` | 表单字段定义编辑器 |
| `components/blueprint/FormMetaEditor.vue` | 表单元数据编辑器 |
| `components/blueprint/RosterSchemaEditor.vue` | 花名册Schema编辑器 |
| `components/blueprint/SchemaFieldItem.vue` | Schema字段编辑行 |
| `components/blueprint/AIModeSelector.vue` | AI参与模式选择器 |
| `components/blueprint/BlueprintPreview.vue` | 变量预览面板 |

### 8.2 修改文件

| 文件路径 | 修改内容 |
|----------|----------|
| `components/game/GameStartPanel.vue` | 重构，整合新的蓝图编辑器 |
| `types/gameStart.ts` | 扩展类型定义，集成蓝图类型 |
| `composables/useAIInteraction.ts` | 添加精确模式下的变量预注入逻辑 |
| `services/PresetService.ts` | 适配新的蓝图数据结构 |

---

## 九、交互流程

### 9.1 完整流程（精确模式）

```

1. 用户打开新聊天，显示开局面板
2. 用户填写基础设定（场景/玩家信息）
3. 用户在花名册Schema编辑器中定义字段
4. 用户在文档蓝图编辑器中：
   a. 创建文档（或从模板/场景预设加载）
   b. 编辑文档树结构（添加章节条款）
   c. 填写各节点的正文内容
   d. （可选）标记为表单文档，编辑 $formMeta 和 $fieldDef
5. 用户选择"精确模式"
6. 用户点击"开始游戏"
7. 前端执行：
   a. 验证蓝图数据完整性
   b. 调用 BlueprintConverter 将蓝图转换为变量
   c. 通过酒馆API直接写入 MC.文档 变量
   d. 通过酒馆API直接写入 MC.花名册.$schema 变量
   e. 生成精确模式提示词
   f. 发送提示词给AI
8. AI 返回：
   a. 开局场景叙事
   b. UpdateVariable（系统/玩家/NPC/申请记录初始化）
9. 系统解析 UpdateVariable，更新变量
10. 显示游戏界面

```

### 9.2 完整流程（智能模式）

```

1-4. 同上
5. 用户选择"智能模式"
6. 用户点击"开始游戏"
7. 前端执行：
   a. 验证蓝图数据
   b. 将蓝图序列化为JSON（作为参考）
   c. 生成智能模式提示词（包含蓝图JSON）
   d. 发送提示词给AI
8. AI 返回：
   a. 开局场景叙事
   b. UpdateVariable（全部变量，包括润色后的文档）
9. 系统解析 UpdateVariable，更新所有变量
10. 显示游戏界面

```

---

## 十、关键设计决策

### 10.1 为什么用扁平Map而非嵌套树

蓝图节点使用 `nodeMap: Map<string, BlueprintNode>` 而不是嵌套对象树，原因：
- **拖拽排序**更简单，只需修改 `parentId` 和 `childIds`
- **查找节点**O(1)，不需要遍历
- **Vue响应式**更高效，修改一个节点不会触发整棵树的重渲染
- 最终输出时再用 `BlueprintConverter` 递归生成嵌套结构

### 10.2 为什么保留基础设定区

场景类型/名称/世界观/玩家信息这些字段结构简单且固定，不需要文档蓝图的灵活性，保持现有的表单输入方式即可。

### 10.3 $meta 标签的处理

**玩家不需要关心 `$meta: { extensible: true }`**——这是变量转换器自动添加的。每个对象层级（文档根、章、节、`_s` 容器）在转换时都会自动注入 `$meta`。这降低了玩家的理解成本。

### 10.4 预设系统的兼容

现有的 [`PresetService`](src/MClite/services/PresetService.ts) 需要适配新的蓝图数据结构。预设从保存 `GameStartFormData`（扁平表单数据）变为保存 `GameStartBlueprint`（含文档蓝图的完整配置）。需要做好新旧预设格式的兼容。

---

## 十一、交互细节补充

### 11.1 节点编号自动递增

当用户点击"添加子节点"时，前端自动推断下一个编号：
- 在"第一章"下添加 → 自动为"第二章 [标题]"
- 在"第一条"的 `_s` 下添加 → 自动为"一"、"二"、"三"
- 在"一"的 `_s` 下添加 → 自动为"1"、"2"、"3"

### 11.2 快捷键支持

- `Tab` → 缩进（转为子节点）
- `Shift+Tab` → 减少缩进（转为父级同级）
- `Enter` → 在当前节点后添加同级节点
- `Ctrl+Enter` → 确认编辑
- `Delete` → 删除当前节点
- `Ctrl+Up/Down` → 上移/下移节点

### 11.3 折叠与展开

- 章/节级别默认展开，条/款级别默认折叠
- 支持"全部展开"/"全部折叠"快捷操作
- 折叠的节点显示子节点数量提示

### 11.4 拖拽排序

支持同级节点之间拖拽重排序。跨级拖拽暂不实现（复杂度高、使用频率低）。

### 11.5 空文档占位

如果没有创建任何文档，显示引导界面：
```

┌──────────────────────────────────────────┐
│  📄 还没有创建任何文档                    │
│                                          │
│  点击下方按钮开始创建：                  │
│                                          │
│  [+ 新建空白文档]                        │
│  [📜 从模板创建]                         │
│  [⚡ 加载场景预设文档]                   │
│                                          │
│  💡 提示：文档用于定义场景的规章制度、    │
│  工作流程和申请表等。你可以创建任意       │
│  数量的文档，也可以全部交给AI生成。       │
└──────────────────────────────────────────┘

```

---

## 十二、后续扩展方向

### 12.1 文档导入/导出
- 支持导出文档蓝图为JSON文件
- 支持从JSON文件导入文档蓝图
- 支持从现有 `MC.文档` 变量反向解析为蓝图（用于编辑已有文档）

### 12.2 文档共享
- 玩家可以将自己创建的文档蓝图分享给他人

### 12.3 实时预览
- 在编辑器旁边实时预览文档的渲染效果（类似 `DocumentPanel.vue` 的样式）

### 12.4 多人协作编辑
- 如果有需要，未来可以支持多个蓝图的并行编辑

---

## 附录：与现有变量结构的对应关系

| 蓝图数据 | 变量路径 | 说明 |
|----------|----------|------|
| `blueprint.docKey` | `MC.文档.{docKey}` | 文档在变量中的key |
| `blueprint.title` | `MC.文档.{docKey}.title` | 文档标题 |
| `blueprint.description` | `MC.文档.{docKey}.description` | 文档描述 |
| `blueprint.formMeta` | `MC.文档.{docKey}.$formMeta` | 表单元数据 |
| `node.nodeKey`(叶子) | `MC.文档.{docKey}.{章}.{节}.{条}` | 叶子节点值为字符串 |
| `node.text`(分支._t) | `MC.文档.{docKey}.{章}.{节}.{条}._t` | 分支节点正文 |
| `node.children`(分支._s) | `MC.文档.{docKey}.{章}.{节}.{条}._s` | 分支节点子集 |
| `node.fieldDefs` | `MC.文档.{docKey}.{章}.{节}.{条}.$fieldDef` | 表单字段定义 |
| `rosterSchema.fields` | `MC.花名册.$schema.fields` | 花名册字段映射 |
| 自动生成 | `*.$meta.extensible` | 每个对象层级自动注入 |
