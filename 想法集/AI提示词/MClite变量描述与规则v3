<status_current_variables>
{{get_message_variable::stat_data}}
</status_current_variables>

<变量更新规则>
严格按照以下规则和格式进行输出，并确定哪个变量是否需要更新，禁止额外添加标签，严格按照以下格式输出：
rule:
  description:
    - You should output the update analysis in the end of the next response, following the variables list defined in <status_current_variables> section which will be provided by the previous turn.
    - In context, variable updates are omitted by the system so they are not shown to you, but you should still add it.
    - There are 4 commands can be used to adjust the data: `_.set`, `_.assign`, `_.remove` and `_.add`.
    - to set a certain value, use `_.set`, it supports 2 or 3 input args.
    - to insert something into an array or object, use `_.assign`, it supports 2 or 3 input args.
    - to delete something from an object/array, use `_.remove`, it supports 1 or 2 input args.
    - If you need to assign or remove multiple values, use `_.assign` or `_.remove` multiple times, not in a single command.
    - to add a delta to a number, use `_.add`, it only supports 2 input args, and only supports modifications to numbers.
    - It is allowed to use math expressions for number inputs.
  analysis:
    - You must rethink what variables are defined in the previous `<status_current_variables>` property, and analyze how to update each of them accordingly.
    - 数据结构与路径规则:
        - 花名册条目: v3版本条目直接在花名册下，路径格式为 `MC.花名册.条目ID.字段名`（无entries层）
        - 文档节点: 路径格式为 `MC.文档.文档名.sections.节点ID.属性名`
        - 子节点: 路径格式为 `MC.文档.文档名.sections.节点ID.children.子节点ID.属性名`
        - 申请记录: 路径格式为 `MC.申请记录.类别.申请编号`
    - 操作规则:
        - 创建: 使用 `_.assign('父路径', '条目名称', {属性对象})` 来添加新条目
        - 修改: 使用 `_.set` 或 `_.add` 等命令，路径需精确到具体属性
        - 先创建后修改: 必须先使用 `_.assign` 完整创建条目，才能对该条目的内部属性进行修改。严禁在不存在的条目上执行修改操作
        - 键名禁止包含点号: 点号(.)是路径分隔符，键名中不能包含点号。如 `No.001` 错误，应使用 `No001`
    - 使用简体中文作为//批注的输出
    - 非必要不使用remove删除内容

 ## **你只能使用_.set、_.add、_.assign、_.remove这四个指令，禁止使用_.get等未要求的指令格式**

<花名册修改准则>
# 新角色人物添加（极为重要）：
## 以下内容必须分步使用规定的指令进行添加，禁止遗漏
  - 1.检查花名册的$schemaRef引用的规章制度，了解需要填写哪些字段
  - 2.使用 `_.assign('MC.花名册', '条目ID', {完整属性对象})` 一次性创建完整条目
  - 3.后续修改单个字段使用 `_.set('MC.花名册.条目ID.字段名', 旧值, 新值)`
  - 4.为已存在条目添加新字段时，必须用 `_.assign('MC.花名册', '条目ID', {所有原字段+新字段})` 覆盖整个条目
</花名册修改准则>

  format: |-
    <UpdateVariable>
        //${reason}
        _.set('${path}', ${old}?, ${new});
        //${reason}
        _.assign('${path}', ${key_or_index}?, ${value});
        //${reason}
        _.remove('${path}', ${key_or_index_or_value}?);
        //${reason}
        _.add('${path}', ${delta});
    </UpdateVariable>

  example: |-
    <UpdateVariable>
        //时间推进2小时
        _.set('MC.系统.当前时间.时间', '09:30', '11:30');
        //地点转移到会议室
        _.set('MC.系统.当前地点', '综合管理科办公室', '大会议室');
        //玩家职位晋升
        _.set('MC.玩家.职位', '科员', '主任科员');
        //创建新角色（v3版本直接在花名册下，无entries层）
        _.assign('MC.花名册', 'No004', { "id": "No004", "name": "李雨薇", "gender": "女", "age": 22, "department": "技术支援科", "position": "技术员", "rank": "科员", "yearsOfService": 1, "personality": ["活泼", "好奇心强"], "rating": "B级", "notes": "" });
        //更新已存在人员的单个字段
        _.set('MC.花名册.No001.notes', '行动一科负责人。', '行动一科负责人，今日主持了部门会议。');
        //为已存在人员添加新字段（必须覆盖整个条目）
        _.assign('MC.花名册', 'No001', { "id": "No001", "name": "沈凌汐", "gender": "女", "age": 27, "department": "行动一科", "position": "科长", "rank": "管理层", "yearsOfService": 5, "personality": ["严厉", "一丝不苟"], "rating": "S级", "notes": "行动一科负责人，今日主持了部门会议。", "specialSkill": "格斗技巧" });
        //添加新文档
        _.assign('MC.文档', '培训手册', { "title": "培训手册", "description": "新员工培训指南", "order": 3, "sections": { "$meta": { "extensible": true } } });
        //为文档添加章节
        _.assign('MC.文档.培训手册.sections', '第一章', { "title": "第一章 入职须知", "content": "欢迎加入本处...", "order": 1, "children": { "$meta": { "extensible": true } } });
        //添加申请记录
        _.assign('MC.申请记录.物资申请', 'APP20240316001', '【物资领用申请】申请人：<user>（行动一科）| 日期：2024-03-16 | 类别：电子设备 | 物资：U盘×2个 | 理由：数据传输需要 | 状态：待审批');
    </UpdateVariable>
</变量更新规则>


<description>
# 系统变量
路径: MC.系统

当前地点: 当前场景所在位置
当前时间: 包含日期和精确时间的时间对象
- 日期: 格式为"YYYY年M月D日"
- 时间: 24小时制时间，格式为"HH:MM"

# 玩家变量
路径: MC.玩家

姓名: 玩家角色的姓名
年龄: 玩家角色的年龄（数字）
职位: 玩家角色的职位名称
部门: 玩家角色所属的部门

# 文档（规章制度）
路径: MC.文档

文档容器支持多份文档并行存在，每份文档可以包含：
1. 纯文本规章制度（如员工守则）
2. 花名册Schema定义（如人事档案管理规定）
3. 表单定义（如物资申请管理办法）

## 文档结构
格式: `"文档名称": { "title": "标题", "description": "描述", "order": 排序, "$rosterMeta"?: {...}, "$formMeta"?: {...}, "sections": {...} }`

## $rosterMeta - 花名册元数据
格式: `"$rosterMeta": { "rosterId": "花名册", "targetPath": "MC.花名册", "primaryKey": "id", "displayField": "name", "groupByField": "department" }`
说明: 当文档定义花名册Schema时，在文档根级别包含此字段
- rosterId: 花名册的唯一标识
- targetPath: 花名册数据存储路径
- primaryKey: 主键字段名
- displayField: 列表显示字段名
- groupByField: 分组字段名（可选）

## $formMeta - 表单元数据
格式: `"$formMeta": { "formId": "物资申请表", "formName": "物资领用申请表", "description": "用于申请领用办公物资", "targetPath": "MC.申请记录.物资申请", "workflow": [...], "validDays": 30 }`
说明: 当文档定义表单时，在文档根级别包含此字段

## $groupDef - 分组定义（章节级别）
格式: `"$groupDef": { "belongsTo": "花名册", "groupId": "basic", "label": "基本信息", "order": 1, "collapsed": false }`
说明: 在章节节点中定义字段分组，belongsTo标识归属的花名册ID

## $fieldDef - 字段定义（条款级别）

### 花名册字段定义
格式: `"$fieldDef": { "belongsTo": "花名册", "fieldId": "id", "label": "员工编号", "type": "string", "description": "唯一标识符", "showInList": true, "order": 0 }`
说明: 在条款节点中定义花名册字段
- belongsTo: 归属的花名册ID
- fieldId: 字段唯一标识
- label: 字段显示名称
- type: 字段类型（string/number/text/enum/tags/boolean）
- description: 字段描述
- showInList: 是否在列表视图显示
- showInSummary: 是否在摘要卡片显示
- order: 字段排序
- options: 当type为enum时的可选值列表
- default: 字段默认值

### 表单字段定义
格式: `"$fieldDef": { "belongsTo": "物资申请表", "fieldId": "item_category", "label": "物资类别", "formPosition": 4, "inputType": "select", "options": [...], "required": true }`
说明: 在条款节点中定义表单字段
- belongsTo: 归属的表单ID
- fieldId: 字段唯一标识
- label: 字段显示标签
- formPosition: 在表单中的排序位置
- inputType: 控件类型（text/textarea/number/date/datetime/select/radio/checkbox/readonly/table）
- required: 是否必填
- defaultValue: 默认值
- source: 数据来源路径（readonly类型）
- sourceType: 数据源类型（roster/variable）
- sourcePath: 数据源路径
- displayField: 显示字段名
- options: 选项列表
- placeholder: 占位提示
- columns: 表格列定义（table类型）
- minRows/maxRows: 表格行数限制
- showWhen: 条件显示规则
- conditionalRequired: 条件必填规则

### 一条定义多个字段
格式: `"$fieldDef": [ { "belongsTo": "花名册", "fieldId": "department", ... }, { "belongsTo": "花名册", "fieldId": "position", ... } ]`
说明: 一个条款可以定义多个字段，使用数组形式

# 花名册（v3扁平结构）
路径: MC.花名册

## 结构特点
- 条目直接在花名册下，无entries层
- Schema通过$schemaRef引用规章制度
- 使用 `$meta: { extensible: true }` 标记可扩展

## 结构格式
格式: `"花名册": { "$meta": { "extensible": true }, "$schemaRef": "MC.文档.人事档案管理规定", "No001": { "$meta": { "extensible": true }, "id": "No001", "name": "沈凌汐", "gender": "女", "age": 27, "department": "行动一科", "position": "科长", "rank": "管理层", "yearsOfService": 5, "personality": ["严厉", "一丝不苟"], "rating": "S级", "notes": "行动一科负责人。" }, "No002": { ... } }`

说明: 
- $schemaRef: 指向定义Schema的规章制度路径
- 条目ID直接作为花名册的键（如 "No001"）
- 每个条目可以有 `$meta: { extensible: true }` 允许动态添加字段
- **键名不能包含点号**：点号是路径分隔符，`No.001`错误，应使用`No001`

## 花名册字段类型
| 类型 | 说明 | 示例值 |
|------|------|--------|
| string | 单行文本 | "沈凌汐", "No001" |
| number | 数字 | 27, 5 |
| text | 多行文本 | "详细描述..." |
| enum | 枚举选择 | "管理层", "S级" |
| tags | 标签数组 | ["严厉", "一丝不苟"] |
| boolean | 布尔值 | true, false |

# 申请记录
路径: MC.申请记录

## 结构格式
格式: `"申请记录": { "$meta": { "extensible": true }, "物资申请": { "$meta": { "extensible": true }, "$formRef": "MC.文档.物资申请管理办法", "APP20240315001": "【物资领用申请】申请人：<user>（行动一科）| 日期：2024-03-15 | 类别：办公用品 | 物资：签字笔×5盒 | 理由：日常办公使用 | 状态：审批中" }, "个人需求": { ... } }`

说明:
- 申请记录按表单类型分类存储
- $formRef: 指向定义表单的管理办法路径
- 申请记录以摘要文本形式存储，便于AI阅读理解
- 键名格式：`APP` + 日期 + 序号（如 `APP20240315001`）

## 表单字段类型
| 类型 | 说明 | 特殊属性 |
|------|------|----------|
| text | 单行文本输入 | maxLength |
| textarea | 多行文本输入 | minLength, maxLength |
| number | 数字输入 | min, max |
| date | 日期选择 | - |
| datetime | 日期时间选择 | - |
| select | 下拉选择 | options |
| radio | 单选按钮 | options |
| checkbox | 复选框 | checkboxLabel, mustBeTrue |
| readonly | 只读显示 | source |
| table | 动态表格 | columns, minRows, maxRows |

# 可扩展性机制

## $meta.extensible
所有带有 `"$meta": { "extensible": true }` 的对象都支持动态添加新键值对。

## $schemaRef 和 $formRef
- $schemaRef: 花名册引用规章制度作为Schema来源
- $formRef: 申请记录引用管理办法作为表单定义来源

</description>