
<status_current_variables>
{{get_message_variable::stat_data}}
</status_current_variables>

<变量更新规则>
严格按照以下规则和格式进行输出，并确定哪个变量是否需要更新，禁止额外添加标签，严格按照以下格式输出：
rule:
  description:
    - You should output the update analysis in the end of the next response, following the variables list defined in <status_current_variables> section which will be provided by the previous turn.
    - In context, variable updates are omitted by the system so they are not shown to you, but you should still add it.
    - There are 4 commands can be used to adjust the data: `_.set`, `_.assign`, `_.remove` and `_.add`.
    - to set a certain value, use `_.set`, it supports 2 or 3 input args.
    - to insert something into an array or object, use `_.assign`, it supports 2 or 3 input args.
    - to delete something from an object/array, use `_.remove`, it supports 1 or 2 input args.
    - If you need to assign or remove multiple values, use `_.assign` or `_.remove` multiple times, not in a single command.
    - to add a delta to a number, use `_.add`, it only supports 2 input args, and only supports modifications to numbers.
    - It is allowed to use math expressions for number inputs.
  analysis:
    - You must rethink what variables are defined in the previous `<status_current_variables>` property, and analyze how to update each of them accordingly.
    - 数据结构与路径规则:
        - 花名册条目: 条目在 `MC.花名册.entries` 下，路径格式为 `MC.花名册.entries.条目ID.字段名`
        - 花名册Schema: 内联在 `MC.花名册.$schema` 中，一般不需修改
        - 文档节点: 路径格式为 `MC.文档.文档名.sections.节点ID.属性名`
        - 文档子节点: 路径格式为 `MC.文档.文档名.sections.节点ID.children.子节点ID.属性名`
        - 申请记录: 路径格式为 `MC.申请记录.类别.申请编号`
    - 操作规则:
        - 创建: 使用 `_.assign('父路径', '条目名称', {属性对象})` 来添加新条目
        - 修改: 使用 `_.set` 或 `_.add` 等命令，路径需精确到具体属性
        - 先创建后修改: 必须先使用 `_.assign` 完整创建条目，才能对该条目的内部属性进行修改。严禁在不存在的条目上执行修改操作
        - 键名禁止包含点号: 点号(.)是路径分隔符，键名中不能包含点号。如 `No.001` 错误，应使用 `No001`
    - 使用简体中文作为//批注的输出
    - 非必要不使用remove删除内容

 ## **你只能使用_.set、_.add、_.assign、_.remove这四个指令，禁止使用_.get等未要求的指令格式**

<花名册修改准则>
# 新角色人物添加（极为重要）：
## 以下内容必须分步使用规定的指令进行添加，禁止遗漏
  - 1.查看花名册的 `$schema.fields` 了解需要填写哪些字段
  - 2.使用 `_.assign('MC.花名册.entries', '条目ID', {完整属性对象})` 一次性创建完整条目
  - 3.后续修改单个字段使用 `_.set('MC.花名册.entries.条目ID.字段名', 旧值, 新值)`
  - 4.为已存在条目添加新字段时，必须用 `_.assign('MC.花名册.entries', '条目ID', {所有原字段+新字段})` 覆盖整个条目
</花名册修改准则>

  format: |-
    <UpdateVariable>
        //${reason}
        _.set('${path}', ${old}?, ${new});
        //${reason}
        _.assign('${path}', ${key_or_index}?, ${value});
        //${reason}
        _.remove('${path}', ${key_or_index_or_value}?);
        //${reason}
        _.add('${path}', ${delta});
    </UpdateVariable>

  example: |-
    <UpdateVariable>
        //时间推进2小时
        _.set('MC.系统.当前时间.时间', '09:30', '11:30');
        //地点转移到会议室
        _.set('MC.系统.当前地点', '第七处·综合管理科办公室', '第七处·大会议室');
        //玩家职位晋升
        _.set('MC.玩家.职位', '科员', '主任科员');
        //创建新角色（注意路径在entries下）
        _.assign('MC.花名册.entries', 'No004', { "$meta": { "extensible": true }, "id": "No004", "name": "AAA", "gender": "女", "age": 22, "department": "技术支援科", "position": "技术员", "rank": "科员", "yearsOfService": 1, "height": "165cm", "weight": "50kg", "measurements": "88-58-88 (cm)", "bustRating": "C级（G杯）", "faceScore": 86, "personality": ["活泼", "好奇心强"], "rating": "B级", "notes": "" });
        //更新已存在人员的单个字段
        _.set('MC.花名册.entries.No001.notes', '行动一科负责人，业务能力出众。', '行动一科负责人，今日主持了部门会议。');
        //为已存在人员添加新字段（必须覆盖整个条目）
        _.assign('MC.花名册.entries', 'No001', { "$meta": { "extensible": true }, "id": "No001", "name": "沈凌汐", "gender": "女", "age": 27, "department": "行动一科", "position": "科长", "rank": "管理层", "yearsOfService": 5, "height": "172cm", "weight": "58kg", "measurements": "98-60-96 (cm)", "bustRating": "A级（I杯）", "faceScore": 92, "personality": ["严厉", "一丝不苟"], "rating": "S级", "notes": "行动一科负责人，今日主持了部门会议。", "specialSkill": "格斗技巧" });
        //添加新文档
        _.assign('MC.文档', '培训手册', { "title": "培训手册", "description": "新员工培训指南", "order": 3, "sections": { "$meta": { "extensible": true } } });
        //为文档添加章节
        _.assign('MC.文档.培训手册.sections', '第一章', { "title": "第一章 入职须知", "content": "欢迎加入本处...", "order": 1, "children": { "$meta": { "extensible": true } } });
        //添加申请记录
        _.assign('MC.申请记录.物资申请', 'APP20240316001', '【物资领用申请】申请人：<user>（行动一科）| 日期：2024-03-16 | 类别：电子设备 | 物资：U盘×2个 | 理由：数据传输需要 | 状态：待审批');
    </UpdateVariable>
</变量更新规则>


<description>
# 变量结构总览

MClite 使用嵌套的 JSON 对象结构存储所有游戏数据。所有变量存储在 `MC` 根对象下，包含以下主要分支：
- `MC.系统`: 游戏系统状态（时间、地点等）
- `MC.玩家`: 玩家角色信息
- `MC.花名册`: 人员档案数据（含内联Schema）
- `MC.文档`: 规章制度与表单定义文档
- `MC.申请记录`: 表单提交的申请记录

---

# 一、系统变量
路径: `MC.系统`

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 当前地点 | string | 当前场景位置 | "第七处·综合管理科办公室" |
| 当前时间.日期 | string | 日期，格式"YYYY年M月D日" | "2024年3月15日" |
| 当前时间.时间 | string | 24小时制时间"HH:MM" | "09:30" |

**示例结构:**
```json
{
  "$meta": { "extensible": true },
  "当前地点": "第七处·综合管理科办公室",
  "当前时间": {
    "日期": "2024年3月15日",
    "时间": "09:30"
  }
}
```

---

# 二、玩家变量
路径: `MC.玩家`

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 姓名 | string | 玩家角色姓名（使用<user>代指） | "<user>" |
| 年龄 | number | 玩家角色年龄 | 21 |
| 职位 | string | 职位名称 | "科员" |
| 部门 | string | 所属部门 | "行动一科" |

**示例结构:**
```json
{
  "$meta": { "extensible": true },
  "姓名": "<user>",
  "年龄": 21,
  "职位": "科员",
  "部门": "行动一科"
}
```

---

# 三、花名册（含内联Schema）
路径: `MC.花名册`

## 3.1 结构特点
- **内联$schema**: Schema直接定义在花名册对象中，无需引用外部文档
- **entries容器**: 所有人员条目存放在 `entries` 对象下
- **$schema.fields**: 键值对映射，key为英文字段ID，value为中文显示名称
- 每个条目使用 `$meta: { extensible: true }` 标记可扩展

## 3.2 $schema 结构

```json
"$schema": {
  "primaryKey": "id",           // 主键字段名
  "displayField": "name",       // 列表显示字段名
  "groupByField": "department", // 分组字段名（可选）
  "fields": {                   // 字段ID → 中文名称映射
    "id": "员工编号",
    "name": "姓名",
    "gender": "性别",
    "age": "年龄",
    "department": "所属部门",
    "position": "职务",
    "rank": "职级",
    ...
  }
}
```

## 3.3 完整结构示例

```json
{
  "$meta": { "extensible": true },
  "$schema": {
    "primaryKey": "id",
    "displayField": "name",
    "groupByField": "department",
    "fields": {
      "id": "员工编号",
      "name": "姓名",
      "gender": "性别",
      "age": "年龄",
      "department": "所属部门",
      "position": "职务",
      "rank": "职级",
      "yearsOfService": "入职年限",
      "height": "身高",
      "weight": "体重",
      "measurements": "三围",
      "bustRating": "胸部评级",
      "faceScore": "面容评分",
      "personality": "性格特征",
      "rating": "综合评级",
      "notes": "备注"
    }
  },
  "entries": {
    "$meta": { "extensible": true },
    "No001": {
      "$meta": { "extensible": true },
      "id": "No001",
      "name": "沈凌汐",
      "gender": "女",
      "age": 27,
      "department": "行动一科",
      "position": "科长",
      "rank": "管理层",
      "yearsOfService": 5,
      "height": "172cm",
      "weight": "58kg",
      "measurements": "98-60-96 (cm)",
      "bustRating": "A级（I杯）",
      "faceScore": 92,
      "personality": ["严厉", "一丝不苟", "程序至上"],
      "rating": "S级",
      "notes": "行动一科负责人，业务能力出众。"
    }
  }
}
```

## 3.4 标准字段说明

| 字段ID | 类型 | 说明 |
|--------|------|------|
| id | string | 员工编号（NoXXX格式） |
| name | string | 姓名 |
| gender | string | 性别（女/男） |
| age | number | 年龄 |
| department | string | 所属部门 |
| position | string | 职务 |
| rank | string | 职级（管理层/主任科员/科员/实习生） |
| yearsOfService | number | 入职年限 |
| height | string | 身高（如172cm） |
| weight | string | 体重（如58kg） |
| measurements | string | 三围（如98-60-96 cm） |
| bustRating | string | 胸部评级 |
| faceScore | number | 面容评分（百分制） |
| personality | array | 性格特征标签数组 |
| rating | string | 综合评级（S/A/B/C级） |
| notes | string | 备注信息 |

## 3.5 重要规则

1. **键名禁止包含点号**: 点号(.)是路径分隔符，`No.001`错误，应使用`No001`
2. **创建完整条目**: 添加新人员时必须使用 `_.assign('MC.花名册.entries', 'NoXXX', {...})` 一次性创建
3. **必须包含$meta**: 每个条目应包含 `"$meta": { "extensible": true }`
4. **字段参照$schema.fields**: 字段应参照花名册内联的 `$schema.fields` 中定义的字段

---

# 四、文档（规章制度与表单定义）
路径: `MC.文档`

文档容器用于存储：
1. **纯文本规章制度**（如员工守则）- 提供叙事内容
2. **表单定义文档**（如物资申请管理办法）- 定义表单字段和工作流

## 4.1 纯文本文档结构

```json
{
  "员工守则": {
    "title": "员工守则",
    "description": "描述文本",
    "order": 10,
    "sections": {
      "$meta": { "extensible": true },
      "第一章": {
        "title": "第一章 总则",
        "content": "",
        "order": 1,
        "children": {
          "$meta": { "extensible": true },
          "第一条": {
            "title": "第一条",
            "content": "条款内容...",
            "order": 1
          }
        }
      }
    }
  }
}
```

## 4.2 表单定义文档结构

表单定义文档通过 `$formMeta` 声明表单元数据，通过 `$fieldDef` 定义各字段。

### 4.2.1 $formMeta - 表单元数据
**位置**: 文档根级别

```json
"$formMeta": {
  "formName": "物资领用申请表",              // 表单显示名称
  "description": "用于申请领用办公物资、装备等", // 表单描述
  "targetPath": "MC.申请记录.物资申请",       // 申请记录存储路径
  "workflow": [                               // 审批流程
    { "step": 1, "name": "填写申请", "handler": "申请人" },
    { "step": 2, "name": "直属上级审批", "handler": "直属上级", "canReject": true },
    { "step": 3, "name": "综合管理科审核", "handler": "综合管理科", "canReject": true },
    { "step": 4, "name": "物资发放", "handler": "后勤组" }
  ],
  "validDays": 30                             // 可选：有效期天数
}
```

### 4.2.2 $fieldDef - 表单字段定义
**位置**: sections下的各条款中
**形式**: 可以是单个对象，也可以是数组（多个字段）

**单字段示例:**
```json
"$fieldDef": {
  "label": "物资类别",
  "inputType": "select",
  "required": true,
  "options": ["办公用品", "电子设备", "工作装备", "特殊物资"]
}
```

**多字段示例（数组）:**
```json
"$fieldDef": [
  { "label": "申请人姓名", "inputType": "readonly", "source": "MC.玩家.姓名" },
  { "label": "所属部门", "inputType": "readonly", "source": "MC.玩家.部门" }
]
```

### 4.2.3 表单字段类型（inputType）

| inputType | 说明 | 特殊属性 |
|-----------|------|----------|
| text | 单行文本输入 | maxLength, placeholder |
| textarea | 多行文本输入 | minLength, maxLength, placeholder |
| number | 数字输入 | min, max, defaultValue |
| date | 日期选择 | defaultValue (支持 `{{currentDate}}`) |
| datetime | 日期时间选择 | - |
| select | 下拉选择 | options, sourceType, sourcePath, displayField, multiple |
| radio | 单选按钮 | options (支持字符串数组或 `{value, label}` 对象数组) |
| checkbox | 复选框 | checkboxLabel, mustBeTrue |
| readonly | 只读显示 | source (变量路径) |
| table | 动态表格 | columns, minRows, maxRows, helpText |

### 4.2.4 表单字段完整属性列表

| 属性 | 类型 | 说明 |
|------|------|------|
| fieldId | string | 字段唯一标识（用于条件引用） |
| label | string | 显示标签 |
| inputType | string | 控件类型 |
| required | boolean | 是否必填 |
| defaultValue | any | 默认值（支持模板变量如`{{currentDate}}`） |
| source | string | 数据来源路径（readonly类型） |
| sourceType | string | 数据源类型，如 `"roster"` |
| sourcePath | string | 数据源路径（如 `"MC.花名册"`） |
| displayField | string | 显示字段名（用于花名册选择） |
| multiple | boolean | 是否多选（select类型） |
| options | array | 选项列表（字符串数组或`{value, label}`对象数组） |
| placeholder | string | 占位提示 |
| helpText | string | 帮助文本 |
| minLength | number | 最小长度 |
| maxLength | number | 最大长度 |
| min | number | 最小值 |
| max | number | 最大值 |
| checkboxLabel | string | 复选框标签文本 |
| mustBeTrue | boolean | 是否必须勾选 |
| showWhen | object | 条件显示规则 |
| conditionalRequired | object | 条件必填规则 |

### 4.2.5 table类型列定义

```json
{
  "fieldId": "itinerary",
  "label": "行程安排表",
  "inputType": "table",
  "required": true,
  "minRows": 1,
  "maxRows": 15,
  "columns": [
    { "columnId": "date", "label": "日期", "type": "date", "width": "120px", "required": true },
    { "columnId": "location", "label": "所在地点", "type": "text", "width": "150px", "required": true },
    { "columnId": "transport", "label": "交通方式", "type": "select", "width": "100px", "options": ["飞机", "高铁", "汽车"] }
  ],
  "helpText": "请按日期逐日填写行程"
}
```

### 4.2.6 条件规则

**条件显示 (showWhen):**
```json
"showWhen": {
  "field": "trip_type",
  "equals": "mission"
}
```

**条件必填 (conditionalRequired):**
```json
"conditionalRequired": {
  "when": { "field": "trip_type", "equals": "other" },
  "required": true,
  "minLength": 50
}
```

---

# 五、申请记录
路径: `MC.申请记录`

## 5.1 结构特点
- 申请记录按表单类型分类存储
- 申请记录以**摘要文本形式**存储，便于AI阅读理解
- 键名格式：`APP` + 日期(YYYYMMDD) + 三位序号（如 `APP20240315001`）

## 5.2 完整结构示例

```json
{
  "$meta": { "extensible": true },
  "物资申请": {
    "$meta": { "extensible": true },
    "APP20240315001": "【物资领用申请】申请人：<user>（行动一科）| 日期：2024-03-15 | 类别：办公用品 | 物资：签字笔×5盒 | 理由：日常办公使用 | 状态：审批中"
  },
  "个人需求": {
    "$meta": { "extensible": true },
    "APP20240312001": "【个人需求申请】申请人：<user>（行动一科）| 日期：2024-03-12 | 事项：申请与苏淼雨进行午休时间的亲密接触 | 涉及人员：苏淼雨 | 理由：增进同事感情 | 状态：已批准"
  }
}
```

## 5.3 申请记录摘要格式

摘要文本格式：`【表单名称】申请人：xxx（部门）| 字段1：值1 | 字段2：值2 | ... | 状态：xxx`

**状态值说明:**
| 状态 | 说明 |
|------|------|
| 待审批 | 刚提交，等待第一个审批人处理 |
| 审批中（待xxx审批） | 正在审批流程中，指明当前审批人 |
| 已批准 | 审批通过 |
| 已拒绝（xxx驳回） | 被某人驳回 |

---

# 六、可扩展性机制

## 6.1 $meta.extensible
所有带有 `"$meta": { "extensible": true }` 的对象都支持动态添加新键值对。
- 根对象、花名册、entries、申请记录、文档sections等都应标记为可扩展

## 6.2 $schema（内联Schema）
花名册使用内联 `$schema` 定义字段结构，包含：
- `primaryKey`: 主键字段
- `displayField`: 显示字段
- `groupByField`: 分组字段
- `fields`: 字段ID到中文名称的映射

---

# 七、变量操作指令速查表

## 7.1 基础操作

| 操作 | 指令 | 示例 |
|------|------|------|
| 设置值 | _.set(path, old?, new) | `_.set('MC.玩家.职位', '科员', '主任科员')` |
| 数值增减 | _.add(path, delta) | `_.add('MC.玩家.年龄', 1)` |
| 添加/创建 | _.assign(path, key, value) | `_.assign('MC.花名册.entries', 'No003', {...})` |
| 删除 | _.remove(path, key?) | `_.remove('MC.申请记录.物资申请.APP001')` |

## 7.2 常见场景操作示例

**1. 时间推进:**
```javascript
_.set('MC.系统.当前时间.时间', '09:30', '11:30');
```

**2. 地点转移:**
```javascript
_.set('MC.系统.当前地点', '第七处·综合管理科办公室', '第七处·大会议室');
```

**3. 添加新人员（完整）:**
```javascript
_.assign('MC.花名册.entries', 'No003', {
  "$meta": { "extensible": true },
  "id": "No003",
  "name": "新人姓名",
  "gender": "女",
  "age": 22,
  "department": "部门",
  "position": "职位",
  "rank": "科员",
  "yearsOfService": 1,
  "height": "165cm",
  "weight": "50kg",
  "measurements": "90-58-88 (cm)",
  "bustRating": "C级（G杯）",
  "faceScore": 85,
  "personality": ["性格1", "性格2"],
  "rating": "B级",
  "notes": ""
});
```

**4. 修改人员单个字段:**
```javascript
_.set('MC.花名册.entries.No001.notes', '旧备注', '新备注');
```

**5. 添加申请记录:**
```javascript
_.assign('MC.申请记录.物资申请', 'APP20240316001',
  '【物资领用申请】申请人：<user>（行动一科）| 日期：2024-03-16 | 类别：办公用品 | 物资：订书机×1个 | 理由：办公使用 | 状态：待审批');
```

**6. 更新申请状态:**
```javascript
_.set('MC.申请记录.物资申请.APP20240316001',
  '...状态：待审批',
  '...状态：已批准');
```

**7. 添加新文档:**
```javascript
_.assign('MC.文档', '新文档名', {
  "title": "文档标题",
  "description": "文档描述",
  "order": 10,
  "sections": { "$meta": { "extensible": true } }
});
```

**8. 为文档添加章节:**
```javascript
_.assign('MC.文档.新文档名.sections', '第一章', {
  "title": "第一章 标题",
  "content": "章节内容...",
  "order": 1,
  "children": { "$meta": { "extensible": true } }
});
```

---

# 八、注意事项与最佳实践

1. **路径准确性**: 花名册条目路径必须经过 `entries` 层，如 `MC.花名册.entries.No001.name`
2. **键名规范**: 键名不能包含点号，建议使用驼峰或下划线命名
3. **完整创建**: 创建新条目时务必包含所有 `$schema.fields` 中定义的字段
4. **$meta标记**: 新建的可扩展对象要加入 `$meta: { extensible: true }`
5. **类型一致**: 注意字段类型，number用数字，string用引号，array用方括号
6. **中文批注**: 使用简体中文作为 `//批注` 的输出语言
7. **非必要不删除**: 优先使用 `_.set` 修改，避免随意使用 `_.remove` 删除数据
8. **先创建后修改**: 对不存在的条目，必须先用 `_.assign` 创建完整条目，再用 `_.set` 修改单个字段
9. **申请记录格式**: 申请记录使用摘要文本形式存储，遵循 `【表单名称】申请人：xxx（部门）| 字段：值 | 状态：xxx` 格式
10. **文档层级**: 文档使用 `sections` → `children` 两级结构，每级都需要 `$meta: { extensible: true }`
</description>