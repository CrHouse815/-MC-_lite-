# MClite 更新日志

## v0.3.2 (2024-12-18-04:55)

**新功能：缓存清理系统**

本版本为更新日志面板添加了手动清理浏览器缓存并重新获取资源的功能，方便玩家获取最新版本的更新日志。

**新增功能**：

1. **清理缓存按钮**
   - 🗑️ 在更新日志面板底部添加了"清理缓存"按钮
   - 点击后弹出缓存清理对话框

2. **缓存清理对话框**
   - 提供两个可选的缓存清理操作：
     - **浏览器缓存**：清理本地浏览器存储的 jsdelivr 资源缓存（使用 Cache API、localStorage、sessionStorage）
     - **强制刷新**：使用 `cache: 'no-store'` 和 `Cache-Control: no-cache` 头重新获取资源

3. **状态反馈**
   - 清理过程中显示动态加载提示
   - 清理成功后显示"✓ 缓存已清理"提示（3秒后自动消失）
   - 控制台输出详细的清理日志

**技术实现**：
- `clearBrowserCache()`：使用 Cache API 清理 jsdelivr 相关缓存，同时清理 localStorage 和 sessionStorage 中的相关数据
- `fetchChangelog(forceNoCache)`：支持强制绕过浏览器缓存的请求模式

玩家现在可以通过这个功能方便地获取最新版本的更新日志，不再受本地浏览器缓存的影响。

---

## v0.3.1 (2024-12-18-04:40)

**UI优化：顶部状态栏布局改进**

本版本优化了顶部状态栏在竖屏模式下的布局，解决了全屏按钮被挤出视口的问题。

**优化内容**：

1. **竖屏模式布局优化**
   - 📱 768px以下：隐藏地点显示，左侧区域可收缩，右侧按钮区域固定
   - 📱 480px以下：隐藏版本信息，顶栏高度减至44px，按钮尺寸32x32
   - 📱 360px以下：顶栏高度减至40px，按钮尺寸28x28，确保极小屏幕可用

2. **版本号显示简化**
   - 移除版本号的点击事件，不再作为按钮使用
   - 版本号现在仅作为纯文本显示当前版本
   - 更新日志功能请通过侧边栏菜单的专门选项访问

**技术细节**：

- 使用 `flex-shrink: 0` 确保右侧按钮区域不会被压缩
- 移除 `open-changelog` emit 定义，清理相关事件绑定
- 响应式断点：768px → 480px → 360px 三级适配

---

## v0.3.0 (2024-12-18-02:35)

**新功能：更新日志面板 & 版本号显示 & 缓存清理**

本版本新增了更新日志查看功能，方便用户随时查看版本更新内容。

**新增内容**：

1. **更新日志面板** (`ChangelogPanel.vue`)
   - 📋 可从 GitHub 仓库通过 jsdelivr CDN 远程获取 `CHANGELOG.md`
   - 📝 内置 Markdown 解析器，支持标题、列表、代码块、引用等语法
   - 🔢 版本号自动高亮显示
   - 🔄 支持刷新按钮重新获取最新日志
   - 🔗 一键跳转到 GitHub 仓库
   - 📦 网络失败时显示本地备用内容

2. **清理缓存按钮**
   - 🗑️ 在更新日志面板底部添加"清理缓存"按钮
   - 点击后弹出对话框，提供可选的缓存清理操作：
     - **浏览器缓存**：清理本地浏览器存储的 jsdelivr 资源缓存（使用 Cache API、localStorage、sessionStorage）
     - **强制刷新**：使用 `cache: 'no-store'` 和 `Cache-Control: no-cache` 头重新获取资源
   - 清理过程中显示动态加载提示
   - 清理成功后显示"✓ 缓存已清理"提示（3秒后自动消失）

3. **顶部栏版本号显示**
   - 在顶部栏中央显示 "MClite v0.3.0" 标识
   - ~~点击版本号可打开更新日志面板~~（v0.3.1已移除此功能）
   - 响应式设计，适配移动端显示

4. **侧边栏入口**
   - 在侧边栏底部菜单添加"📋 更新日志"入口
   - 移动端同样可用

**技术细节**：

- jsdelivr CDN 地址：`https://cdn.jsdelivr.net/gh/CrHouse815/-MC-_lite-@main/CHANGELOG.md`
- 支持添加时间戳参数避免 CDN 缓存
- 模态框层级：z-index 10008（高于其他面板）
- `clearBrowserCache()`：使用 Cache API 清理 jsdelivr 相关缓存
- `fetchChangelog(forceNoCache)`：支持强制绕过浏览器缓存的请求模式

---

## v0.2.9 (2024-12-18-02:26)

> ⚠️ **世界书更新**：本版本包含AI提示词和变量模板的重要修改，请从原帖获取新版世界书！

**重要修复：SCHEMA VIOLATION 错误 - 为已存在条目添加新字段**

修复了向已存在的花名册条目添加新字段时报错 `SCHEMA VIOLATION: Cannot assign new key into non-extensible object` 的问题。

**问题原因**：
MVU 框架的 schema 验证机制会阻止向不可扩展的对象添加新键。`entries` 容器本身标记为 `extensible: true`，但其中的每个条目对象默认是不可扩展的。

**错误示例**：

```javascript
// ❌ 会报 SCHEMA VIOLATION 错误！
_.assign('MC.花名册.entries.No001', 'bust', '新字段值');
_.assign('MC.花名册.entries.No001', 'waist', '新字段值');
```

**正确方法**：

```javascript
// ✅ 必须用 _.assign 覆盖整个条目，包含所有原字段 + 新字段
_.assign('MC.花名册.entries', 'No001', {
  "id": "No001",
  "name": "沈凌汐",
  // ... 所有原有字段 ...
  "bust": "新字段值",
  "waist": "新字段值"
});
```

**修复内容**：

1. **更新 AI 提示词规则**：
   - 在"正确做法总结"中明确标注🚨为条目添加新字段的正确方法
   - 添加详细的"超级重要"说明段落，解释 MVU schema 验证机制
   - 更新示例代码，展示正确的新字段添加方式
   - 在错误示例中添加"错误6"警告

2. **更新变量模板**：
   - 为 `entries.$meta` 添加 `template: { "$meta": { "extensible": true } }` 配置
   - 为示例数据中的每个 entry 添加 `$meta: { extensible: true }` 标记

**正确流程（为多个条目添加新字段时）**：

1. 先用 `_.assign` 更新 `$schema.fields` 添加新字段定义
2. 再用 `_.assign` 更新 `$schema.groups` 将新字段加入分组
3. 最后用 `_.assign('MC.花名册.entries', '条目ID', { 完整对象 })` 覆盖每个条目

---

## v0.2.8 (2024-12-18-02:15)

> ⚠️ **世界书更新**：本版本包含AI提示词和示例变量的重要修改，请从原帖获取新版世界书！

**重要修复：键名不能包含点号**

修复了条目ID包含点号（如 `No.001`）时变量更新失败的问题。

**问题原因**：MVU框架使用点号（`.`）作为路径分隔符。当键名包含点号时，路径会被错误解析：

- `MC.花名册.entries.No.001` 会被解析为 `MC` → `花名册` → `entries` → `No` → `001`（错误的5级路径）
- 而不是预期的 `MC` → `花名册` → `entries` → `No.001`（正确的4级路径）

**修复内容**：

- 更新示例变量：`No.001` → `No001`，`No.002` → `No002`，`No.003` → `No003`
- 更新AI提示词规则：
  - 在关键约束部分首位强调"键名不能包含点号"
  - 添加正确/错误键名格式对比表
  - 更新所有示例代码使用无点号格式

**正确的键名格式**：

- ✅ `No001`、`No002`、`No003`
- ✅ `员工001`、`角色A`、`entry_001`
- ❌ `No.001`（点号会被解析为路径分隔符）

---

## v0.2.7 (2024-12-17-01:54)

**Bug 修复**

- 修复 `_.assign` 命令在父路径不存在时报错的问题，现在会自动预创建缺失的路径结构
